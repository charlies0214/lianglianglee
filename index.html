<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>📚 我的笔记索引</title>
  <script type="module" src="https://unpkg.com/vue@3.4.21/dist/vue.esm-browser.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body.dark { background-color: #1f2937; color: #f9fafb; }
    a:hover { text-decoration: underline; }
    summary { cursor: pointer; }
  </style>
</head>
<body class="p-6 bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100">
  <div id="app" class="max-w-4xl mx-auto">
    <header class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">📚 我的笔记索引</h1>
      <button @click="dark = !dark" class="text-sm px-3 py-1 bg-gray-300 dark:bg-gray-700 rounded">
        切换主题
      </button>
    </header>

    <input type="text" v-model="search" placeholder="🔍 输入关键词搜索..." class="w-full px-4 py-2 mb-4 border rounded dark:bg-gray-700 dark:border-gray-600" />

    <ul>
      <tree-node :nodes="filteredTree" />
    </ul>
  </div>

  <script type="module">
    const { createApp, ref, computed } = Vue;

    const TreeNode = {
      name: 'TreeNode',
      props: ['nodes'],
      setup(props) {
        return { props };
      },
      template: `
        <template v-for="(value, key) in props.nodes">
          <li v-if="key === '__files__'">
            <ul>
              <li v-for="file in value" class="pl-4">
                📄 <a :href="file.path" class="text-blue-500 hover:underline" target="_blank">{ '{' } file.name { '}' }</a>
              </li>
            </ul>
          </li>
          <li v-else>
            <details open class="mb-2">
              <summary class="font-semibold">📁 { '{' } key { '}' }</summary>
              <tree-node :nodes="value" />
            </details>
          </li>
        </template>
      `
    };

    const app = createApp({
      components: { TreeNode },
      setup() {
        const search = ref('');
        const dark = ref(false);
        const tree = ref({});

        fetch('index-data.json')
          .then(res => res.json())
          .then(data => { tree.value = data; });

        const filteredTree = computed(() => {
          const filterTree = (node) => {
            const newNode = {};
            for (const key in node) {
              if (key === '__files__') {
                const files = node[key].filter(f =>
                  f.name.toLowerCase().includes(search.value.toLowerCase())
                );
                if (files.length) newNode[key] = files;
              } else {
                const child = filterTree(node[key]);
                if (Object.keys(child).length > 0) newNode[key] = child;
              }
            }
            return newNode;
          };
          return filterTree(structuredClone(tree.value));
        });

        return { search, filteredTree, dark };
      },
    });
    app.mount('#app');
  </script>
</body>
</html>
